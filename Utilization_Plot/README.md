# utilization_plot.py
This python script reads a dump of the output of [gpustat](https://github.com/wookayin/gpustat) and generates plots for GPU utilization, VRAM utilization, and GPU power consumption over time. The script can also read the files generated by [memprof](https://github.com/WyoARCC/memprof) and add the to the GPU utilization graph.

## Table Of Contents
- [Release notes](#release-notes)
    * [Usage](#usage)
    * [Changelog](#changelog)
    * [Known issues](#known-issues)

## Release notes
Requires [matplotlib](https://pypi.org/project/matplotlib) to run. 
## Usage
To run the application clone the Repo then run the script on the file.
```
git clone https://github.com/WyoARCC/GPU_benchmarking_toolkit_for_ML
cd GPU_benchmarking_toolkit_for_ML/Utilization_Plot/
python3 utilization_plot.py /location/of/file.log
```
This will generate the resource utilization graphs in the same directory as the file specified to the script. These utilization graphs will be named after the file used to create them. As an example, a file named file1.log will produce three graphs: file1.log_GPU_Utilization.png, file1.log_Power_Utilization.png, and file1.log_VRAM_Utilization.png.

The example plots can be generated by executing the following commands in the proper directories:
```
[Basic_Usage_Example]$ python3 ../../utilization_plot.py gpustat.log --interval 25
[CPU_Utilization_Example]$ python3 ../../utilization_plot.py ./gpustat.log --plot-cpu --memprof-files ./memprof/memprof-2467978.csv ./memprof/memprof-2758405.csv ./memprof/memprof-3178485.csv ./memprof/memprof-3751346.csv
[CPU_Utilization_Example]$ python3 ../../utilization_plot.py ./gpustat.log --rename subplot --plot-cpu --sub-plot --memprof-files ./memprof/memprof-2467978.csv ./memprof/memprof-2758405.csv ./memprof/memprof-3178485.csv ./memprof/memprof-3751346.csv
[Offset_Flag_Example]$ python3 ../../utilization_plot.py ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-gpustat.log --plot-cpu --memprof-files ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-12060.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-1497511.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-16966.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-362770.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-43.csv
[Offset_Flag_Example]$ python3 ../../utilization_plot.py ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-gpustat.log --plot-cpu --rename adjusted --offset -6 --memprof-files ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-12060.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-1497511.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-16966.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-362770.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-43.csv
[Multi_GPU_Example]$ python3 ../../utilization_plot.py gpustat.log --memprof-dir memprof/ --interval 60
[Multi_GPU_Example]$ python3 ../../utilization_plot.py gpustat.log --memprof-dir memprof/ --split --interval 60
```

## Generating Your Own gpustat.log Files
The gpustat.log files used with this application are generated by launching [gpustat](https://github.com/wookayin/gpustat) in the background and redirecting its output to a file. Below is an example of such a call.
```
gpustat -a -i 60 > gpustat.log 2>&1 &
```
This call will check the gpu utilization every 60 seconds and send the output to a file called gpustat.log in the same directory that it is called from. After launching gpustat in this manner the commands that are to be profiled can be launched in the same bash script.
### Changelog
2023/05/24
- Updated examples in the Multi_GPU_Example subdirectory and the function call in README.md.

2023/05/23
- Updated examples in the Multi_GPU_Example subdirectory.

2023/05/22
- Added new command line flag to set if a CPU utilzation plot will be created.
- Renamed '--cpu-files' flag to '--memprof-files'
- Updated examples to reflect changes to command line flags.

2023/05/17
- Added missing units to power and VRAM utilization plots.
- Regenerated the example files to include this information.

2023/05/16
- Added flag to read a directory for [memprof](https://github.com/WyoARCC/memprof) generated files to plot.
- Added new example that demonstrates multi-GPU capabilities.
- Updated examples to demonstrates new appearance of plots.

2023/05/11
- Updated the script to generate continuous utilization plots using the files read from [memprof.](https://github.com/WyoARCC/memprof)
- Updated the examples to include the plots generated using data from memprof files.

2023/05/09
- Updated the script to allow splitting of the GPU and CPU utilization to subplots in same figure.
- Updated existing example and added new examples to the [example](https://github.com/WyoARCC/GPU_benchmarking_toolkit_for_ML/tree/main/Utilization_Plot/example) subfolder.
 
2023/05/08
- Updated the script to display the total runtime of the benchmark on the X axis of the generated plots.

2023/05/05
- Added a time offest flag to get GPU time events and CPU time events to align.

2023/05/04
- Updated code to process files created by memprof and add them to the GPU utilization plot.
- Renamed script and folder to correspond with new functionality of script.

2023/04/18
- Refactored code that generates the plot to a function.
- Added code that allows splitting multiple GPUs into separate  plots.
- Renamed the subdirectory to fit name scheme of other subdirectories. 

2023/04/13
- Added command line flags to allow customization of the generated plots from the command line.

2023/04/11
- Updated code to display legend and updated the example files to display the legend.
- Updated code to dynamically set interval for the x axis in generated plots.

2023/04/10
- Initial commit.

### Known issues

There are no known issues in this release.
