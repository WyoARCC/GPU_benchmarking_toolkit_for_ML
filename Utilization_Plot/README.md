# utilization_plot.py
This python script reads a dump of the output of [gpustat](https://github.com/wookayin/gpustat) and generates plots for GPU utilization, VRAM utilization, and GPU power consumption over time. The script can also read the files generated by [memprof](https://github.com/WyoARCC/memprof) and add the to the GPU utilization graph.

## Table Of Contents
- [Release notes](#release-notes)
    * [Usage](#usage)
    * [Changelog](#changelog)
    * [Known issues](#known-issues)

## Release notes
Requires [matplotlib](https://pypi.org/project/matplotlib) to run. 
## Usage
To run the application clone the Repo then run the script on the file.
```
git clone https://github.com/WyoARCC/GPU_benchmarking_toolkit_for_ML
cd GPU_benchmarking_toolkit_for_ML/Utilization_Plot/
python3 utilization_plot.py /location/of/file.log
```
This will generate the resource utilization graphs in the same directory as the file specified to the script. These utilization graphs will be named after the file used to create them. As an example, a file named file1.log will produce three graphs: file1.log_GPU_Utilization.png, file1.log_Power_Utilization.png, and file1.log_VRAM_Utilization.png.

The example plots can be generated by executing the following commands in the proper directories:
```
[Basic_Usage_Example]$ python3 ../../utilization_plot.py gpustat.log --interval 25
Summary Of Usage Of GPU Resource: [0] NVIDIA A30
-------------------------------------------------------------------------------------------------------
GPU Driver Version: 510.85.02
Time On GPU: 210.2 Minutes
Minimum GPU Utilization: 0.0
Maximum GPU Utilization: 41.0
Average GPU Utilization: 38.14691943127962
Minimum VRAM Utilization: 45.0 / 24576.0 MB
Maximum VRAM Utilization: 4233.0 / 24576.0 MB
Average VRAM Utilization: 1273.1042654028436 / 24576.0 MB
Minimum Power Draw: 30.0 / 165.0 Watts
Maximum Power Draw: 64.0 / 165.0 Watts
Average Power Draw: 52.58293838862559 / 165.0 Watts

[CPU_Utilization_Example]$ python3 ../../utilization_plot.py ./gpustat.log --plot-cpu --memprof-files ./memprof/memprof-2467978.csv ./memprof/memprof-2758405.csv ./memprof/memprof-3178485.csv ./memprof/memprof-3751346.csv
-------------------------------------------------------------------------------------------------------
Summary Of Usage Of System Resources
-------------------------------------------------------------------------------------------------------
Time On CPU: 320.0 Minutes
Minimum CPU Utilization: 0.0%
Maximum CPU Utilization: 112.0%
Average CPU Utilization: 66.68504765375629%
Minimum Number Of Threads: 1.0
Maximum Number Of Threads: 9.0
Average Number Of Threads: 8.963231081714493
Minimum VmSize: 48244.0 kB
Maximum VmSize: 37647568.0 kB
Average VmSize: 22943413.030363 kB
Minimum VmRSS: 8592.0 kB
Maximum VmRSS: 4756940.0 kB
Average VmRSS: 4179173.4182594656 kB
Minimum Data Read From Memory: 0.0 Bytes/s
Maximum Data Read From Memory: 4027956173.0 Bytes/s
Average Data Read From Memory: 17388385.544971615 Bytes/s
Minimum Data Written To Memory: 0.0 Bytes/s
Maximum Data Written To Memory: 1509005002.0 Bytes/s
Average Data Written To Memory: 3762514.224311234 Bytes/s

-------------------------------------------------------------------------------------------------------
Summary Of Usage Of GPU Resource: [0] NVIDIA A30
-------------------------------------------------------------------------------------------------------
GPU Driver Version: 510.85.02
Time On GPU: 319.3 Minutes
Minimum GPU Utilization: 0.0
Maximum GPU Utilization: 99.0
Average GPU Utilization: 63.671875
Minimum VRAM Utilization: 0.0 / 24576.0 MB
Maximum VRAM Utilization: 21133.0 / 24576.0 MB
Average VRAM Utilization: 9733.46875 / 24576.0 MB
Minimum Power Draw: 27.0 / 165.0 Watts
Maximum Power Draw: 193.0 / 165.0 Watts
Average Power Draw: 116.428125 / 165.0 Watts

[CPU_Utilization_Example]$ python3 ../../utilization_plot.py ./gpustat.log --rename subplot --plot-cpu --sub-plot --memprof-files ./memprof/memprof-2467978.csv ./memprof/memprof-2758405.csv ./memprof/memprof-3178485.csv ./memprof/memprof-3751346.csv
(The summary is the same as above.)
[Offset_Flag_Example]$ python3 ../../utilization_plot.py ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-gpustat.log --plot-cpu --memprof-files ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-12060.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-1497511.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-16966.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-362770.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-43.csv
-------------------------------------------------------------------------------------------------------
Summary Of Usage Of System Resources
-------------------------------------------------------------------------------------------------------
Time On CPU: 486.6166666666667 Minutes
Minimum CPU Utilization: 0.0%
Maximum CPU Utilization: 198.0%
Average CPU Utilization: 100.92585793547504%
Minimum Number Of Threads: 1.0
Maximum Number Of Threads: 38.0
Average Number Of Threads: 16.370333584492087
Minimum VmSize: 20120.0 kB
Maximum VmSize: 20369976.0 kB
Average VmSize: 19378524.49167751 kB
Minimum VmRSS: 3624.0 kB
Maximum VmRSS: 4488268.0 kB
Average VmRSS: 4405695.1369271865 kB
Minimum Data Read From Memory: 0.0 Bytes/s
Maximum Data Read From Memory: 6558429588.0 Bytes/s
Average Data Read From Memory: 26794599.99589013 Bytes/s
Minimum Data Written To Memory: 0.0 Bytes/s
Maximum Data Written To Memory: 7611387019.0 Bytes/s
Average Data Written To Memory: 2349497.1370641827 Bytes/s

-------------------------------------------------------------------------------------------------------
Summary Of Usage Of GPU Resource: [0] NVIDIA GeForce RTX 3090
-------------------------------------------------------------------------------------------------------
GPU Driver Version: 515.76
Time On GPU: 486.4333333333333 Minutes
Minimum GPU Utilization: 0.0
Maximum GPU Utilization: 98.0
Average GPU Utilization: 74.6611909650924
Minimum VRAM Utilization: 0.0 / 24576.0 MB
Maximum VRAM Utilization: 7237.0 / 24576.0 MB
Average VRAM Utilization: 5915.498973305955 / 24576.0 MB
Minimum Power Draw: 22.0 / 350.0 Watts
Maximum Power Draw: 328.0 / 350.0 Watts
Average Power Draw: 275.38398357289526 / 350.0 Watts

[Offset_Flag_Example]$ python3 ../../utilization_plot.py ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-gpustat.log --plot-cpu --rename adjusted --offset -6 --memprof-files ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-12060.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-1497511.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-16966.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-362770.csv ./fastspeech-job-rtx3090-memprof-bugfix-lskcf-memprof/memprof-43.csv
(The summary is the same as above.)
[Multi_GPU_Example]$ python3 ../../utilization_plot.py gpustat.log --memprof-dir memprof/ --interval 60
-------------------------------------------------------------------------------------------------------
Summary Of Usage Of System Resources
-------------------------------------------------------------------------------------------------------
Time On CPU: 1294.0166666666667 Minutes
Minimum CPU Utilization: 0.0%
Maximum CPU Utilization: 0.0%
Average CPU Utilization: 0.0%
Minimum Number Of Threads: 1.0
Maximum Number Of Threads: 1.0
Average Number Of Threads: 1.0
Minimum VmSize: 5792.0 kB
Maximum VmSize: 5792.0 kB
Average VmSize: 5792.0 kB
Minimum VmRSS: 3184.0 kB
Maximum VmRSS: 3392.0 kB
Average VmRSS: 3216.962127067553 kB
Minimum Data Read From Memory: 0.0 Bytes/s
Maximum Data Read From Memory: 344519202.0 Bytes/s
Average Data Read From Memory: 5786.3673803266865 Bytes/s
Minimum Data Written To Memory: 0.0 Bytes/s
Maximum Data Written To Memory: 357316505.0 Bytes/s
Average Data Written To Memory: 5991.37950224146 Bytes/s

-------------------------------------------------------------------------------------------------------
Summary Of Usage Of GPU Resource: [0] NVIDIA A30
-------------------------------------------------------------------------------------------------------
GPU Driver Version: 510.85.02
Time On GPU: 1292.7833333333333 Minutes
Minimum GPU Utilization: 0.0
Maximum GPU Utilization: 100.0
Average GPU Utilization: 38.6415313225058
Minimum VRAM Utilization: 0.0 / 24576.0 MB
Maximum VRAM Utilization: 22077.0 / 24576.0 MB
Average VRAM Utilization: 13203.781902552204 / 24576.0 MB
Minimum Power Draw: 29.0 / 165.0 Watts
Maximum Power Draw: 198.0 / 165.0 Watts
Average Power Draw: 68.44431554524363 / 165.0 Watts

-------------------------------------------------------------------------------------------------------
Summary Of Usage Of GPU Resource: [1] NVIDIA A30
-------------------------------------------------------------------------------------------------------
GPU Driver Version: 510.85.02
Time On GPU: 1292.7833333333333 Minutes
Minimum GPU Utilization: 0.0
Maximum GPU Utilization: 100.0
Average GPU Utilization: 39.964037122969835
Minimum VRAM Utilization: 0.0 / 24576.0 MB
Maximum VRAM Utilization: 23123.0 / 24576.0 MB
Average VRAM Utilization: 6475.996519721578 / 24576.0 MB
Minimum Power Draw: 30.0 / 165.0 Watts
Maximum Power Draw: 187.0 / 165.0 Watts
Average Power Draw: 69.31090487238978 / 165.0 Watts

[Multi_GPU_Example]$ python3 ../../utilization_plot.py gpustat.log --memprof-dir memprof/ --split --interval 60
(The summary is the same as above.)
```

## Generating Your Own gpustat.log Files
The gpustat.log files used with this application are generated by launching [gpustat](https://github.com/wookayin/gpustat) in the background and redirecting its output to a file. Below is an example of such a call.
```
gpustat -a -i 60 > gpustat.log 2>&1 &
```
This call will check the gpu utilization every 60 seconds and send the output to a file called gpustat.log in the same directory that it is called from. After launching gpustat in this manner the commands that are to be profiled can be launched in the same bash script.
### Changelog
2023/05/31
- Rewrote functions for plotting the utilization data to accommodate easier creation of other types of utilization plots.
- Created new function that displays utilization statistics to the terminal window.
- Regenerated the example plots to correspond with changes made in the rewrite of the data plotting functions.
- Updated README.md with results of the utilization statistics with the example files.

2023/05/24
- Updated examples in the Multi_GPU_Example subdirectory and the function call in README.md.

2023/05/23
- Updated examples in the Multi_GPU_Example subdirectory.

2023/05/22
- Added new command line flag to set if a CPU utilzation plot will be created.
- Renamed '--cpu-files' flag to '--memprof-files'
- Updated examples to reflect changes to command line flags.

2023/05/17
- Added missing units to power and VRAM utilization plots.
- Regenerated the example files to include this information.

2023/05/16
- Added flag to read a directory for [memprof](https://github.com/WyoARCC/memprof) generated files to plot.
- Added new example that demonstrates multi-GPU capabilities.
- Updated examples to demonstrates new appearance of plots.

2023/05/11
- Updated the script to generate continuous utilization plots using the files read from [memprof.](https://github.com/WyoARCC/memprof)
- Updated the examples to include the plots generated using data from memprof files.

2023/05/09
- Updated the script to allow splitting of the GPU and CPU utilization to subplots in same figure.
- Updated existing example and added new examples to the [example](https://github.com/WyoARCC/GPU_benchmarking_toolkit_for_ML/tree/main/Utilization_Plot/example) subfolder.
 
2023/05/08
- Updated the script to display the total runtime of the benchmark on the X axis of the generated plots.

2023/05/05
- Added a time offest flag to get GPU time events and CPU time events to align.

2023/05/04
- Updated code to process files created by memprof and add them to the GPU utilization plot.
- Renamed script and folder to correspond with new functionality of script.

2023/04/18
- Refactored code that generates the plot to a function.
- Added code that allows splitting multiple GPUs into separate  plots.
- Renamed the subdirectory to fit name scheme of other subdirectories. 

2023/04/13
- Added command line flags to allow customization of the generated plots from the command line.

2023/04/11
- Updated code to display legend and updated the example files to display the legend.
- Updated code to dynamically set interval for the x axis in generated plots.

2023/04/10
- Initial commit.

### Known issues

There are no known issues in this release.
